<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:security="http://www.springframework.org/schema/security"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:p="http://www.springframework.org/schema/p"
	xmlns:aop="http://www.springframework.org/schema/aop"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:jee="http://www.springframework.org/schema/jee" xmlns:mvc="http://www.springframework.org/schema/mvc"
	xsi:schemaLocation="  
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
        http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-3.1.xsd  
        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.1.xsd  
        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.1.xsd  
        http://www.springframework.org/schema/cache http://www.springframework.org/schema/cache/spring-cache-3.1.xsd  
        http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc-3.1.xsd  
        http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-3.1.xsd  
        http://www.springframework.org/schema/jms http://www.springframework.org/schema/jms/spring-jms-3.1.xsd  
        http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang-3.1.xsd  
        http://www.springframework.org/schema/oxm http://www.springframework.org/schema/oxm/spring-oxm-3.1.xsd  
        http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task-3.1.xsd  
        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.1.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd" default-lazy-init="false">

		<!-- 权限管理器 -->
	<bean id="securityManager" class="org.apache.shiro.web.mgt.DefaultWebSecurityManager">
		<property name="realm" ref="shiroRealm" />
		<property name="sessionManager" ref="sessionManager" />
		<!-- 缓存管理器 -->
		<property name="cacheManager" ref="shiroCacheManager" />
	</bean>
	
<bean id="sessionManager" class="org.apache.shiro.web.session.mgt.DefaultWebSessionManager">
<!-- 超时时间 -->
    <property name="globalSessionTimeout" value="3600000"/>
    <property name="sessionDAO" ref="shiroSessionDao"/>
    <property name="sessionIdCookie" ref="sharesession"/>
    <!-- 定时检查失效的session -->
     <property name="sessionValidationSchedulerEnabled" value="true" />
</bean>


<bean id="sharesession" class="org.apache.shiro.web.servlet.SimpleCookie">
    <constructor-arg name="name" value="SHAREJSESSIONID"/>
</bean>
<bean id="shiroSessionDao"  class="org.apache.shiro.session.mgt.eis.EnterpriseCacheSessionDAO" />

<!-- 单机session -->
<bean id="shiroCacheManager" class="org.apache.shiro.cache.MemoryConstrainedCacheManager" /> 

	<!-- session 集群 -->
	<!-- 
	<bean id="shiroCacheManager" class="org.springrain.frame.shiro.ShiroRedisCacheManager" > 
	<property name="cached" ref="redisCached" />
	</bean>
	 -->

	 <bean id="kickoutSessionControlFilter"   class="cn.telling.shirocontroller.KickoutSessionControlFilter">  
	    <property name="cacheManager" ref="shiroCacheManager"/>  
	    <property name="sessionManager" ref="sessionManager"/>  <!-- 用于根据会话ID，获取会话进行踢出操作的； -->
	  
	    <property name="kickoutAfter" value="false"/>  <!-- 是 踢出后来登录的，默认是false；即后者登录的用户踢出前者登录的用户； -->
	    <property name="maxSession" value="1"/>  <!-- 同一个用户最大的会话数，默认1；比如2的意思是同一个用户允许最多同时两个人登录； -->
	    <property name="kickoutUrl" value="/getout.html?kickout=1"/>  <!-- 被踢出后重定向到的地址； -->
	</bean>   


	<bean id="shiroFilter" class="org.apache.shiro.spring.web.ShiroFilterFactoryBean"
		depends-on="frameperms">
		<property name="securityManager" ref="securityManager" />
		<property name="loginUrl" value="/login.html" />
		<property name="successUrl" value="/viewAllContacts.html" />
		<property name="unauthorizedUrl" value="/noAuth.html" />
		<property name="filterChainDefinitions">
			<value>
			   /sys/pdf/**= authc	<!--  采购合同文件查看权限-->
			   /js/** = anon
			   /css/** = anon
			   /img/** = anon
			   /json/** = user
			   /Plug/** = anon
			   /images/** = anon
			   /ui/** =anon
			  	/login.html = anon
			   /validate.html=anon
			  /loginValid.html=anon
			   /favicon.ico = anon
			   /taglib_includes.jsp= anon
			   /common/common.jsp= anon
			   /error/** = authc
			   /index.jsp = anon
			   /viewAllContacts.html = authc,kickout	<!-- 系统后台主页-->
			   /viewLeftMenuJson.html=user	<!-- 系统左侧菜单查询 -->
			   /getcblphotoById.html= authc	<!-- 图片查询 -->
			   /gettaxtaxregphotoById.html= authc	<!-- 图片查询 -->
			   /getBIGGoodsImagePhotoById.html=authc	<!-- 图片原图查询 -->
			   /getorgstrucodephotoById.html= authc	<!-- 图片查询 -->
			   /getCblProPhotoById.html= authc	<!-- 图片查询 -->
			   /gettaxtaxregProPhotoById.html= authc	<!-- 图片查询  -->
			   /getorgstrucodeProPhotoById.html= authc	<!-- 图片查询  -->
			   /getYlPhotoById.html=authc		<!-- 图片预览  -->
			   /getGoodsImagePhotoById.html= authc	<!-- 图片查询  -->
			   /viewCompanyJson.html= authc	<!-- 公司下拉数据 by用户关系表-->
			   /viewFrontUserCompanyJson.html= authc	<!-- 公司下拉数据 by会员 关系表-->
			   /viewCompanyByContactsReJson.html= authc	<!-- 公司下拉数据by联系人关系表 -->
			   /purchasingManagement.html=authc	<!-- 采购合同确认框  -->
			   /pmtempView.html=anon				<!-- 采购合同确认  -->
			   /conPMfirmOrders.html=authc		<!-- 生成采购合同  -->
			   /viewDW.html=authc					<!-- 提货仓库下拉框信息显示  -->
			   /bolsucaction.html=authc	<!-- 系统提示  -->
			   /deliversuc.html=authc	<!-- 系统提示  -->
			   /addGoodsMultipleFile.html=anon		<!-- 多图上传  -->
			   /lxrsysmsg.html=authc		<!-- 系统提示  -->
			   /monitoring=authc		<!-- 系统监控  -->
			   /getslaesJsValue.html=authc	<!-- 预结算金额 提示信息 -->
			   
			   /competencesys.html= user	<!--  无权限页面-->
			   /main.html= user			<!--  系统后台右侧首页-->
			   /userlogout.html = anon
			   /noAuth.html = anon
			   /getout.html = anon 	<!-- 重复登录踢出-->
			   /loginValid.html = anon	<!--  登录验证-->
			   /**/ajax/** = user
			   /** = kickout,user,frameperms
			   <!-- /user/list.html=user -->
			</value>
		</property>
		
		<!-- 声明自定义的过滤器 -->
		<property name="filters">
			<map>
				<entry key="frameperms" value-ref="frameperms"></entry>
				<entry key="kickout" value-ref="kickoutSessionControlFilter"/>
			</map>
		</property>
	</bean>
	
	<!-- 起效权限注解,这个很少在web项目中用到,一般是控制url的访问,不是在controller中声明权限注解 -->
	<bean id="lifecycleBeanPostProcessor" class="org.apache.shiro.spring.LifecycleBeanPostProcessor" />
</beans>